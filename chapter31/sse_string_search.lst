     1                                  ; sse_string_search.asm
     2                                  extern	printf
     3                                  section	.data
     4                                  ;template		 123456789012345678901234567890123456789012345  6
     5                                  ;template		 0123456789abcdef0123456789abcdef0123456789abc  d
     6 00000000 74686520717569636B-     	string1	db	"the quick brown fox jumps over the lazy river",0
     6 00000009 2062726F776E20666F-
     6 00000012 78206A756D7073206F-
     6 0000001B 76657220746865206C-
     6 00000024 617A79207269766572-
     6 0000002D 00                 
     7 0000002E 6500                    	string2	db	"e",0
     8 00000030 54686973206973206F-     	fmt1	db	"This is our string: %s ",10,0
     8 00000039 757220737472696E67-
     8 00000042 3A202573200A00     
     9 00000049 546865206669727374-     	fmt2	db	"The first '%s' is at position %d.",10,0
     9 00000052 202725732720697320-
     9 0000005B 617420706F73697469-
     9 00000064 6F6E2025642E0A00   
    10 0000006C 546865206C61737420-     	fmt3	db	"The last '%s' is at position %d.",10,0
    10 00000075 272573272069732061-
    10 0000007E 7420706F736974696F-
    10 00000087 6E2025642E0A00     
    11 0000008E 546865206368617261-     	fmt4	db	"The character '%s' didn't show up!.",10,0
    11 00000097 637465722027257327-
    11 000000A0 206469646E27742073-
    11 000000A9 686F77207570212E0A-
    11 000000B2 00                 
    12                                  section	.bss
    13                                  section	.text
    14                                  	global main
    15                                  main:
    16 00000000 55                      	push	rbp
    17 00000001 4889E5                  	mov	rbp,rsp
    18 00000004 48BF-                   	mov 	rdi,fmt1
    18 00000006 [3000000000000000] 
    19 0000000E 48BE-                       	mov 	rsi,string1
    19 00000010 [0000000000000000] 
    20 00000018 4831C0                  	xor	rax,rax
    21 0000001B E8(00000000)            	call	printf
    22                                  ; find the first occurance.
    23 00000020 48BF-                   	mov	rdi,string1
    23 00000022 [0000000000000000] 
    24 0000002A 48BE-                   	mov	rsi,string2
    24 0000002C [2E00000000000000] 
    25 00000034 E87D000000              	call	pstrscan_f
    26 00000039 4883F800                	cmp	rax,0
    27 0000003D 7459                    	je	no_show
    28 0000003F 48BF-                   	mov	rdi,fmt2
    28 00000041 [4900000000000000] 
    29 00000049 48BE-                   	mov	rsi,string2
    29 0000004B [2E00000000000000] 
    30 00000053 4889C2                  	mov	rdx,rax
    31 00000056 4831C0                  	xor	rax,rax
    32 00000059 E8(00000000)            	call	printf
    33                                  ; find the last occurance.
    34 0000005E 48BF-                   	mov	rdi,string1
    34 00000060 [0000000000000000] 
    35 00000068 48BE-                   	mov	rsi,string2
    35 0000006A [2E00000000000000] 
    36 00000072 E86E000000              	call	pstrscan_l
    37 00000077 48BF-                   	mov	rdi,fmt3
    37 00000079 [6C00000000000000] 
    38 00000081 48BE-                   	mov	rsi,string2
    38 00000083 [2E00000000000000] 
    39 0000008B 4889C2                  	mov	rdx,rax
    40 0000008E 4831C0                  	xor	rax,rax
    41 00000091 E8(00000000)            	call	printf
    42 00000096 EB1C                    	jmp	exit
    43                                  no_show:
    44 00000098 48BF-                   	mov	rdi,fmt4
    44 0000009A [8E00000000000000] 
    45 000000A2 48BE-                   	mov	rsi,string2
    45 000000A4 [2E00000000000000] 
    46 000000AC 4831C0                  	xor	rax,rax
    47 000000AF E8(00000000)            	call	printf
    48                                  exit:
    49 000000B4 C9                      leave
    50 000000B5 C3                      ret
    51                                  ;------ find the first occurrence ----------------------
    52                                  pstrscan_f:
    53 000000B6 55                      	push	rbp
    54 000000B7 4889E5                  	mov	rbp,rsp
    55                                  
    56 000000BA 4831C0                  	xor	rax,rax
    57 000000BD 660FEFC0                	pxor	xmm0,xmm0
    58 000000C1 660F3A200600            	pinsrb	xmm0,[rsi],0
    59                                  .block_loop:
    60 000000C7 660F3A63040700          	pcmpistri xmm0,[rdi+rax],00000000b
    61 000000CE 7208                    	jc	.found
    62 000000D0 740E                    	jz	.none
    63 000000D2 4883C010                	add	rax,16
    64 000000D6 EBEF                    	jmp	.block_loop
    65                                  .found:
    66 000000D8 4801C8                  	add	rax,rcx
    67 000000DB 48FFC0                  	inc	rax,
    68 000000DE C9                      leave
    69 000000DF C3                      ret
    70                                  .none:	
    71 000000E0 4831C0                  	xor	rax,rax
    72 000000E3 C9                      leave
    73 000000E4 C3                      ret
    74                                  ;------ find the last occurrence ----------------------
    75                                  pstrscan_l:
    76 000000E5 55                      	push	rbp
    77 000000E6 4889E5                  	mov	rbp,rsp
    78                                  
    79 000000E9 53                      	push	rbx
    80 000000EA 4154                    	push	r12
    81 000000EC 4831C0                  	xor	rax,rax
    82 000000EF 660FEFC0                	pxor	xmm0,xmm0
    83 000000F3 660F3A200600            	pinsrb	xmm0,[rsi],0
    84 000000F9 4D31E4                  	xor	r12,r12
    85                                  .block_loop:
    86 000000FC 660F3A63040740          	pcmpistri xmm0,[rdi+rax],01000000b
    87 00000103 0F94C3                  	setz	bl
    88 00000106 7208                    	jc	.found
    89 00000108 741F                    	jz	.none
    90 0000010A 4883C010                	add	rax,16
    91 0000010E EBEC                    	jmp	.block_loop
    92                                  .found:
    93 00000110 4989C4                  	mov	r12,rax
    94 00000113 4901CC                  	add	r12,rcx		; rcx contains the position of the char.
    95 00000116 49FFC4                  	inc	r12
    96 00000119 80FB01                  	cmp	bl,1
    97 0000011C 740B                    	je	.none
    98 0000011E 4883C010                	add	rax,16
    99 00000122 EBD8                    	jmp	.block_loop
   100 00000124 415C                    	pop	r12
   101 00000126 5B                      	pop	rbx
   102 00000127 C9                      leave
   103 00000128 C3                      ret
   104                                  .none:
   105 00000129 4C89E0                  	mov	rax,r12
   106 0000012C 415C                    	pop	r12
   107 0000012E 5B                      	pop	rbx
   108 0000012F C9                      leave
   109 00000130 C3                      ret
